<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT_ECHO // LOG_ENTRY</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 奇点风格配色：冷白、深渊黑、警报红 */
            --bg-deep: #050505;
            --ui-white: #e0e0e0;
            --ui-dim: #4a4a4a;
            --accent-cyan: #00f0ff;
            --accent-red: #ff2a2a;
            
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--ui-white);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* 背景：动态星尘/网格 */
        #bg-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.3;
        }

        /* --- 主界面容器 (悬浮玻璃风格) --- */
        #interface-container {
            position: relative;
            z-index: 10;
            width: 1200px;
            max-width: 95vw;
            height: 800px;
            max-height: 90vh;
            display: flex;
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* 左侧：奇点观测窗 (70%) */
        #visual-sector {
            flex: 7;
            position: relative;
            overflow: hidden;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        /* 核心视觉 Canvas */
        #echo-canvas {
            width: 100%;
            height: 100%;
        }

        /* 视觉覆盖层 UI */
        .overlay-ui {
            position: absolute;
            pointer-events: none;
            font-size: 10px;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.5);
        }
        .tl { top: 20px; left: 20px; }
        .br { bottom: 20px; right: 20px; text-align: right; }
        
        .status-badge {
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 2px 6px;
            font-size: 9px;
            margin-right: 10px;
        }

        /* 右侧：数据日志 (30%) */
        #log-sector {
            flex: 3;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: rgba(0,0,0,0.5);
        }

        #log-header {
            height: 60px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        h1 {
            font-family: var(--font-head);
            font-size: 14px;
            margin: 0;
            letter-spacing: 3px;
        }

        /* 滚动日志区 */
        #log-feed {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
        }

        /* 隐藏滚动条但保留功能 */
        #log-feed::-webkit-scrollbar { width: 2px; }
        #log-feed::-webkit-scrollbar-thumb { background: var(--ui-dim); }

        .entry {
            margin-bottom: 25px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            border-left: 1px solid var(--ui-dim);
            padding-left: 15px;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .timestamp {
            font-size: 10px;
            color: var(--ui-dim);
            display: block;
            margin-bottom: 5px;
            font-family: var(--font-head);
        }

        .redacted {
            background: var(--ui-white);
            color: var(--ui-white);
            padding: 0 2px;
            cursor: help;
        }
        .redacted:hover {
            background: transparent;
            color: var(--ui-white);
        }

        /* 交互区域 */
        #interaction-panel {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 极简按钮 */
        button {
            background: transparent;
            border: 1px solid var(--ui-dim);
            color: var(--ui-white);
            padding: 12px;
            font-family: var(--font-head);
            font-size: 10px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 240, 255, 0.05);
            padding-left: 20px;
        }

        button::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 0%; height: 100%;
            background: var(--accent-cyan);
            transition: width 0.3s;
            z-index: -1;
            opacity: 0.1;
        }
        button:hover::after { width: 100%; }

        button.danger:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* 音频波形条 */
        #audio-vis {
            height: 2px;
            width: 100%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-top: 10px;
            opacity: 0.3;
        }
        .bar { width: 2px; background: white; height: 2px; }

        /* 故障特效类 */
        .glitch-text {
            animation: text-glitch 2s infinite;
        }
        @keyframes text-glitch {
            0% { transform: translate(0); }
            2% { transform: translate(-2px, 1px); }
            4% { transform: translate(2px, -1px); }
            6% { transform: translate(0); }
            100% { transform: translate(0); }
        }

    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="interface-container">
        
        <div id="visual-sector">
            <div class="overlay-ui tl">
                <span class="status-badge">ONLINE</span>
                <span>OBSERVATION_DECK_04</span>
            </div>
            <div class="overlay-ui br">
                <div>ECHO_RESONANCE: <span id="res-val">0.00%</span></div>
                <div>COORDINATES: NULL</div>
            </div>
            
            <canvas id="echo-canvas"></canvas>
        </div>

        <div id="log-sector">
            <div id="log-header">
                <h1>PROJECT_ECHO</h1>
                <div style="font-size: 10px; color:#666;">LOG_ID: #9921</div>
            </div>

            <div id="log-feed">
                <div class="entry">
                    <span class="timestamp">SYS.INIT // 00:00:00</span>
                    <p>连接建立。<br>神经同步率稳定。<br>等待音频引擎启动...</p>
                </div>
            </div>

            <div id="interaction-panel">
                <div id="audio-vis">
                    </div>
                <div id="btn-group" style="display:flex; flex-direction:column; gap:8px;">
                    <button id="start-btn" onclick="Game.init()">[ INITIALIZE LINK ]</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ECHO 视觉引擎 (数学几何艺术) ---
        const EchoVisuals = {
            canvas: document.getElementById('echo-canvas'),
            bgCanvas: document.getElementById('bg-canvas'),
            ctx: null, bgCtx: null,
            w: 0, h: 0,
            frame: 0,
            intensity: 0, // 随音乐律动
            state: 'idle', // idle, active, unstable

            init() {
                this.ctx = this.canvas.getContext('2d');
                this.bgCtx = this.bgCanvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop();
            },

            resize() {
                this.w = this.canvas.width = this.canvas.offsetWidth;
                this.h = this.canvas.height = this.canvas.offsetHeight;
                this.bgCanvas.width = window.innerWidth;
                this.bgCanvas.height = window.innerHeight;
            },

            // 绘制背景粒子
            drawBg() {
                const ctx = this.bgCtx;
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                for(let i=0; i<50; i++) {
                    const x = (Math.sin(this.frame * 0.001 + i) * 0.5 + 0.5) * window.innerWidth;
                    const y = (Math.cos(this.frame * 0.002 + i*2) * 0.5 + 0.5) * window.innerHeight;
                    ctx.fillRect(x, y, 1, 1);
                }
            },

            // 绘制核心奇点 (Singularity)
            drawSingularity() {
                const ctx = this.ctx;
                const cx = this.w / 2;
                const cy = this.h / 2;
                
                // 清空并保留拖尾
                ctx.fillStyle = 'rgba(5, 5, 5, 0.15)';
                ctx.fillRect(0, 0, this.w, this.h);

                // 核心圆环
                ctx.lineWidth = 1;
                const baseRadius = 100;
                // 音乐律动影响半径
                const pulse = this.intensity * 20; 

                // 1. 内部黑洞
                ctx.beginPath();
                ctx.arc(cx, cy, baseRadius - 20 + pulse/2, 0, Math.PI*2);
                ctx.fillStyle = '#000';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.stroke();

                // 2. 旋转的几何环 (Project Echo 风格)
                ctx.save();
                ctx.translate(cx, cy);
                
                // 环 A
                ctx.rotate(this.frame * 0.005);
                ctx.strokeStyle = this.state === 'unstable' ? '#ff2a2a' : 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(0, 0, baseRadius + pulse, 0, Math.PI * 1.5);
                ctx.stroke();

                // 环 B (反向)
                ctx.rotate(-this.frame * 0.01);
                ctx.strokeStyle = this.state === 'unstable' ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 240, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(0, 0, baseRadius + 40 + pulse, 0, Math.PI);
                ctx.stroke();

                // 环 C (大虚线)
                ctx.rotate(this.frame * 0.002);
                ctx.setLineDash([2, 20]);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.beginPath();
                ctx.arc(0, 0, baseRadius + 100, 0, Math.PI*2);
                ctx.stroke();
                
                ctx.restore();

                // 3. 故障扫描线 (当 Unstable 时)
                if (this.state === 'unstable' && Math.random() > 0.8) {
                    const y = Math.random() * this.h;
                    ctx.strokeStyle = '#fff';
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(this.w, y);
                    ctx.stroke();
                }
            },

            loop() {
                this.frame++;
                this.drawBg();
                this.drawSingularity();
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- 2. 氛围音频引擎 (Ethereal Audio) ---
        const AudioCore = {
            ctx: null,
            gainNode: null,
            analyser: null,
            
            init() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.gainNode = this.ctx.createGain();
                this.gainNode.gain.value = 0.2;
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 32;
                
                this.gainNode.connect(this.analyser);
                this.analyser.connect(this.ctx.destination);
                
                this.startDrone();
                this.visualize();
            },

            startDrone() {
                // 创建两个互调的振荡器，产生空灵感
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                
                osc1.type = 'sine';
                osc1.frequency.value = 110; // A2
                
                osc2.type = 'triangle';
                osc2.frequency.value = 111; // 轻微失谐产生 Beat

                // LFO 控制音量波动
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 0.1;
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 50;
                lfo.connect(lfoGain).connect(osc1.frequency);

                osc1.connect(this.gainNode);
                osc2.connect(this.gainNode);
                
                osc1.start();
                osc2.start();
                lfo.start();
            },

            playGlitch() {
                // 播放尖锐的故障音
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.1);
                gain.gain.value = 0.1;
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain).connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.1);
            },

            visualize() {
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                
                const update = () => {
                    this.analyser.getByteFrequencyData(dataArray);
                    // 计算平均音量作为 intensity 传给视觉引擎
                    let sum = 0;
                    for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                    const avg = sum / dataArray.length;
                    
                    EchoVisuals.intensity = avg / 255; // 0.0 - 1.0
                    
                    // 更新 UI 波形条
                    const barContainer = document.getElementById('audio-vis');
                    barContainer.innerHTML = '';
                    for(let i=0; i<10; i++) {
                        const h = (dataArray[i] / 255) * 20;
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        bar.style.height = Math.max(2, h) + 'px';
                        barContainer.appendChild(bar);
                    }

                    requestAnimationFrame(update);
                };
                update();
            }
        };

        // --- 3. 游戏逻辑 ---
        const Game = {
            logCount: 0,
            
            init() {
                AudioCore.init();
                EchoVisuals.init();
                EchoVisuals.state = 'active';
                this.addLog("音频核心... [同步完成]", "SYS");
                this.addLog("视觉矩阵... [在线]", "SYS");
                
                // 延迟进入第一章
                setTimeout(() => this.loadScene('start'), 1000);
            },

            addLog(text, sender="DAT") {
                const feed = document.getElementById('log-feed');
                const time = new Date().toTimeString().split(' ')[0];
                
                const div = document.createElement('div');
                div.className = 'entry';
                div.innerHTML = `
                    <span class="timestamp">${sender} // ${time}</span>
                    <p>${text}</p>
                `;
                feed.appendChild(div);
                feed.scrollTop = feed.scrollHeight;
                this.logCount++;
            },

            updateButtons(choices) {
                const panel = document.getElementById('btn-group');
                panel.innerHTML = ''; // 清空
                choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.innerHTML = `>> ${c.text}`;
                    if(c.danger) btn.classList.add('danger');
                    btn.onclick = () => {
                        AudioCore.playGlitch();
                        this.loadScene(c.next);
                    };
                    panel.appendChild(btn);
                });
            },

            loadScene(id) {
                const scene = script[id];
                if(scene.visualState) EchoVisuals.state = scene.visualState;
                
                this.addLog(scene.text);
                
                if(scene.choices) {
                    this.updateButtons(scene.choices);
                }
            }
        };

        // --- 剧本 ---
        const script = {
            'start': {
                text: "收到异常信号。<br>来源：奇点观测站 [Echo]。<br>信号包含大量加密数据，建议谨慎解码。",
                visualState: 'active',
                choices: [
                    { text: "开始解码数据流", next: 'decode_1' },
                    { text: "扫描异常波段", next: 'scan' }
                ]
            },
            'decode_1': {
                text: "解码中...<br>解析出一段语音：<br>“...不要看...<span class='redacted'>眼睛</span>...它在看着你...”",
                visualState: 'active',
                choices: [
                    { text: "追踪信号源", next: 'trace' },
                    { text: "中断连接", next: 'disconnect' }
                ]
            },
            'scan': {
                text: "扫描完成。<br>警告：检测到 <span class='glitch-text'>高维干涉</span>。<br>共振率上升至 40%。",
                visualState: 'unstable',
                choices: [
                    { text: "尝试稳定力场", next: 'stabilize' },
                    { text: "记录波形并撤退", next: 'disconnect' }
                ]
            },
            'trace': {
                text: "追踪成功。<br>坐标指向...你的位置。<br>它就在屏幕后面。",
                visualState: 'unstable',
                choices: [
                    { text: "回头看 (危险)", next: 'end_death', danger: true },
                    { text: "强制关机", next: 'end_safe' }
                ]
            },
            'stabilize': {
                text: "力场稳定失败。<br>奇点正在扩张。<br>系统即将崩溃...",
                visualState: 'unstable',
                choices: [
                    { text: "上传意识", next: 'end_upload', danger: true }
                ]
            },
            'disconnect': {
                text: "连接中断。<br>你逃过了一劫，但这只是暂时的。<br>Echo 永远在监听。",
                visualState: 'idle',
                choices: [
                    { text: "重置终端", next: 'start' }
                ]
            },
            'end_death': {
                text: "信号丢失... <br>SUBJECT_LOST.",
                visualState: 'unstable',
                choices: [ { text: "重启", next: 'start' } ]
            },
            'end_upload': {
                text: "意识上传完成。<br>你已成为 Echo 的一部分。",
                visualState: 'active',
                choices: [ { text: "...", next: 'start' } ]
            },
            'end_safe': {
                text: "系统已关闭。<br>晚安，操作员。",
                visualState: 'idle',
                choices: [ { text: "重启", next: 'start' } ]
            }
        };

        // 启动背景动画
        EchoVisuals.init();

    </script>
</body>
</html>
