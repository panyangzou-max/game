<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT_QI // PARTICLE_LOG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --crt-blue: #00f3ff;
            --crt-amber: #ffb000;
            --crt-red: #ff003c;
            --glass-bg: rgba(10, 15, 20, 0.6);
        }

        * { box-sizing: border-box; user-select: none; cursor: crosshair; }

        body {
            margin: 0;
            background-color: #000;
            height: 100vh;
            overflow: hidden;
            font-family: 'Share Tech Mono', monospace;
            color: var(--crt-blue);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- CRT 屏幕特效容器 --- */
        #crt-frame {
            position: relative;
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #111 0%, #000 120%);
            overflow: hidden;
        }

        /* 扫描线滤镜 */
        #crt-frame::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 999;
            opacity: 0.8;
        }

        /* 屏幕微光 */
        #crt-frame::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle, rgba(0,243,255,0) 50%, rgba(0,243,255,0.05) 100%);
            pointer-events: none;
            z-index: 999;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* UI 层 */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
            padding: 20px;
        }

        /* 磁带未来主义 UI 组件 */
        .panel {
            position: absolute;
            pointer-events: auto;
            background: var(--glass-bg);
            border: 1px solid rgba(0, 243, 255, 0.2);
            backdrop-filter: blur(4px);
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            transition: all 0.3s ease;
        }
        .panel:hover { border-color: var(--crt-blue); box-shadow: 0 0 25px rgba(0, 243, 255, 0.2); }

        .top-left { top: 20px; left: 20px; width: 200px; }
        .top-center { top: 20px; left: 50%; transform: translateX(-50%); text-align: center; border: none; background: transparent; box-shadow: none;}
        .right-menu { top: 50%; right: 20px; transform: translateY(-50%); width: 300px; display: flex; flex-direction: column; gap: 10px; }

        /* 字体排版 */
        h1, h2, h3 { margin: 0; font-weight: normal; text-transform: uppercase; letter-spacing: 2px; }
        .label { font-size: 10px; color: #666; margin-bottom: 2px; }
        .val { font-size: 24px; font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px currentColor; }
        .cyan { color: var(--crt-blue); }
        .red { color: var(--crt-red); }
        
        /* 进度条 */
        .bar-frame { width: 100%; height: 6px; background: #222; border: 1px solid #444; margin-top: 5px; }
        .bar-fill { height: 100%; width: 100%; background: var(--crt-red); box-shadow: 0 0 10px var(--crt-red); transition: width 0.2s; }

        /* 升级按钮 */
        .btn-upgrade {
            background: rgba(0,0,0,0.6);
            border: 1px solid #333;
            color: #888;
            padding: 12px;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Share Tech Mono', monospace;
            transition: 0.2s;
        }
        .btn-upgrade:hover:not(.disabled) {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--crt-blue);
            color: #fff;
            padding-left: 18px;
        }
        .btn-upgrade.disabled { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
        
        .cost-tag { color: var(--crt-amber); font-weight: bold; }

        /* 启动画面 */
        #boot-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .glitch-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 60px;
            color: #fff;
            text-shadow: 2px 2px var(--crt-red), -2px -2px var(--crt-blue);
            animation: glitch 1s infinite alternate;
        }
        @keyframes glitch { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 100% { transform: skew(0deg); } }
        
        .start-btn {
            margin-top: 50px; padding: 15px 40px;
            background: transparent; color: var(--crt-blue);
            border: 2px solid var(--crt-blue);
            font-family: 'Orbitron'; font-size: 20px; letter-spacing: 5px;
            cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 10px var(--crt-blue);
        }
        .start-btn:hover { background: var(--crt-blue); color: #000; box-shadow: 0 0 50px var(--crt-blue); }

        /* 飘字 */
        .floater { position: absolute; pointer-events: none; font-weight: bold; font-size: 14px; animation: floatUp 1s forwards; text-shadow: 0 0 5px currentColor; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

    </style>
</head>
<body>

    <audio id="bgm" src="assets/bgm.mp3" loop></audio>

    <div id="crt-frame">
        <canvas id="game-canvas"></canvas>

        <div id="ui-layer">
            <div class="panel top-left">
                <div class="label">ENERGY_BUFFER</div>
                <div class="val cyan"><span id="ui-energy">0</span></div>
                <div class="label" style="margin-top:10px;">THREAT_WAVE</div>
                <div class="val" style="color:#fff; font-size:18px;"><span id="ui-wave">1</span></div>
            </div>

            <div class="panel top-center">
                <div class="label">SYSTEM INTEGRITY</div>
                <div class="bar-frame" style="width:400px;">
                    <div class="bar-fill" id="ui-hp-bar"></div>
                </div>
                <div class="label" style="text-align:center; margin-top:2px;"><span id="ui-hp-text">100</span>%</div>
            </div>

            <div class="panel right-menu">
                <div class="label" style="border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">CONFIG_MENU</div>
                
                <div class="btn-upgrade" id="btn-gun" onclick="Game.upgrade('gun')">
                    <div>
                        <div>MAIN_LASER <span style="font-size:10px; background:#333; padding:2px;">LV<span id="lv-gun">1</span></span></div>
                        <div class="label" id="desc-gun">单发模式</div>
                    </div>
                    <div class="cost-tag" id="cost-gun">50</div>
                </div>

                <div class="btn-upgrade" id="btn-turret" onclick="Game.upgrade('turret')">
                    <div>
                        <div>DRONE_UNIT <span style="font-size:10px; background:#333; padding:2px;">LV<span id="lv-turret">0</span></span></div>
                        <div class="label">浮游攻击终端</div>
                    </div>
                    <div class="cost-tag" id="cost-turret">100</div>
                </div>

                <div class="btn-upgrade" id="btn-stasis" onclick="Game.upgrade('stasis')">
                    <div>
                        <div>STASIS_FIELD <span style="font-size:10px; background:#333; padding:2px;">LV<span id="lv-stasis">0</span></span></div>
                        <div class="label">时间减速立场</div>
                    </div>
                    <div class="cost-tag" id="cost-stasis">150</div>
                </div>

                <div class="btn-upgrade" id="btn-rate" onclick="Game.upgrade('rate')">
                    <div>
                        <div>DATA_MINING</div>
                        <div class="label">提升自动/点击获取</div>
                    </div>
                    <div class="cost-tag" id="cost-rate">30</div>
                </div>

                <div class="btn-upgrade" id="btn-heal" onclick="Game.upgrade('heal')">
                    <div>
                        <div>SYS_REBOOT</div>
                        <div class="label">修复 30% 核心</div>
                    </div>
                    <div class="cost-tag" id="cost-heal">50</div>
                </div>
            </div>
        </div>

        <div id="boot-screen">
            <div class="glitch-text">PROJECT_QI</div>
            <div style="color:#666; margin-top:10px; font-size:12px; letter-spacing:2px;">VISUAL SYSTEM: PARTICLE // AUDIO: ENABLED</div>
            <button class="start-btn" onclick="Game.init()">BOOT_SYSTEM</button>
        </div>
    </div>

    <script>
        // --- 粒子系统 (核心视觉引擎) ---
        class Particle {
            constructor(x, y, type) {
                this.x = x; this.y = y;
                this.type = type; // 'core', 'bullet', 'spark', 'orb', 'enemy'
                this.vx = (Math.random()-0.5) * 2;
                this.vy = (Math.random()-0.5) * 2;
                this.life = 1.0;
                this.decay = Math.random() * 0.02 + 0.01;
                this.size = Math.random() * 2 + 1;
                
                if(type === 'core') { this.color = '#00f3ff'; this.vx *= 0.1; this.vy *= 0.1; }
                if(type === 'spark') { this.color = '#fff'; this.vx *= 4; this.vy *= 4; this.decay = 0.05; }
                if(type === 'trail') { this.color = 'rgba(0, 243, 255, 0.5)'; this.decay = 0.08; this.vx=0; this.vy=0; }
                if(type === 'enemy_trail') { this.color = 'rgba(255, 0, 60, 0.5)'; this.decay = 0.1; }
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= this.decay;
                if(this.type === 'core') {
                    // 核心粒子会被吸向中心，形成黑洞效果
                    const dx = Game.cx - this.x; const dy = Game.cy - this.y;
                    this.vx += dx * 0.001; this.vy += dy * 0.001;
                }
            }
            draw(ctx) {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }

        // --- 音频引擎 (混合模式) ---
        const AudioSys = {
            ctx: null, bgm: null,
            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.bgm = document.getElementById('bgm');
                this.startBGM();
                this.startDrone(); // 无论是否有MP3，都播放程序化底噪
            },
            startBGM() {
                if(this.bgm) { this.bgm.volume = 0.4; this.bgm.play().catch(e=>{}); }
            },
            startDrone() {
                // 生成深邃的太空底噪
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.value = 50;
                // 低通滤波
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 120;
                
                gain.gain.value = 0.1;
                osc.connect(filter).connect(gain).connect(this.ctx.destination);
                osc.start();
            },
            sfx(type) {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain).connect(this.ctx.destination);
                
                if (type === 'shoot') {
                    osc.frequency.setValueAtTime(600, t);
                    osc.frequency.exponentialRampToValueAtTime(100, t+0.2);
                    gain.gain.value = 0.1; osc.start(); osc.stop(t+0.2);
                } else if (type === 'hit') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, t);
                    gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
                    osc.start(); osc.stop(t+0.1);
                } else if (type === 'collect') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1000, t);
                    osc.frequency.linearRampToValueAtTime(1500, t+0.1);
                    gain.gain.value = 0.1; osc.start(); osc.stop(t+0.1);
                }
            }
        };

        // --- 游戏核心 ---
        const Game = {
            canvas: document.getElementById('game-canvas'),
            ctx: null,
            w: 0, h: 0, cx: 0, cy: 0,
            frame: 0, running: false,

            energy: 0, hp: 100, maxHp: 100, wave: 1,
            
            upgrades: {
                gun: { lvl:1, max:5, cost:50 },
                turret: { lvl:0, max:5, cost:100 },
                stasis: { lvl:0, max:3, cost:150 },
                rate: { lvl:1, cost:30 },
                heal: { cost:50 }
            },

            particles: [], enemies: [], bullets: [], orbs: [],
            
            autoRate: 1, lastFire: 0,

            init() {
                document.getElementById('boot-screen').style.display = 'none';
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', ()=>this.resize());
                
                this.canvas.addEventListener('mousedown', e => this.onClick(e));
                this.canvas.addEventListener('touchstart', e => this.onClick(e.touches[0]));

                AudioSys.init();
                this.running = true;
                this.loop();
                this.updateUI();
            },

            resize() {
                this.w = this.canvas.width = window.innerWidth;
                this.h = this.canvas.height = window.innerHeight;
                this.cx = this.w/2; this.cy = this.h/2;
            },

            spawnParticle(x, y, type, count=1) {
                for(let i=0; i<count; i++) this.particles.push(new Particle(x, y, type));
            },

            onClick(e) {
                const mx = e.clientX, my = e.clientY;
                // 资源收集
                for(let i=this.orbs.length-1; i>=0; i--) {
                    const o = this.orbs[i];
                    if(Math.hypot(o.x-mx, o.y-my) < o.r + 30) {
                        const amt = 10 + this.upgrades.rate.lvl * 5;
                        this.energy += amt;
                        this.spawnParticle(o.x, o.y, 'spark', 10);
                        this.floatText(o.x, o.y, `+${amt}`, '#00f3ff');
                        AudioSys.sfx('collect');
                        this.orbs.splice(i, 1);
                        this.updateUI();
                        return;
                    }
                }
            },

            upgrade(type) {
                const u = this.upgrades[type];
                if(type === 'heal') {
                    if(this.energy >= u.cost && this.hp < this.maxHp) {
                        this.energy -= u.cost; this.hp = Math.min(this.maxHp, this.hp+30);
                        u.cost = Math.floor(u.cost * 1.5);
                        this.updateUI();
                    }
                    return;
                }
                if(this.energy >= u.cost && (u.max ? u.lvl < u.max : true)) {
                    this.energy -= u.cost; u.lvl++; u.cost = Math.floor(u.cost * 1.4);
                    if(type==='rate') this.autoRate = 1 + u.lvl*0.5;
                    this.updateUI();
                }
            },

            // --- 循环与逻辑 ---
            loop() {
                if(!this.running) return;
                this.frame++;
                
                // 1. 生成逻辑
                if(this.frame % 60 === 0) { this.energy += this.autoRate; this.updateUI(); }
                
                // 资源生成 (粒子球)
                if(this.frame % (180 - this.upgrades.rate.lvl*5) === 0) {
                    const pad=100;
                    this.orbs.push({
                        x: pad+Math.random()*(this.w-pad*2), y: pad+Math.random()*(this.h-pad*2),
                        vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5,
                        r: 10, life: 600, angle: 0
                    });
                }

                // 敌人生成 (波次)
                if(this.frame % Math.max(60, 200 - this.wave*5) === 0) {
                    const ang = Math.random() * Math.PI * 2;
                    const dist = Math.max(this.w, this.h) / 1.5;
                    // 敌人类型
                    let type = 'std'; let hp = 15+this.wave*5; let spd = 0.5+this.wave*0.05; let color = '#ff003c';
                    if(this.wave>2 && Math.random()>0.7) { type='heavy'; hp*=2; spd*=0.6; color='#ff8800'; }
                    
                    this.enemies.push({
                        x: this.cx+Math.cos(ang)*dist, y: this.cy+Math.sin(ang)*dist,
                        hp, maxHp: hp, speed: spd, color, type, radius: type==='heavy'?20:12
                    });
                }
                if(this.frame % 1800 === 0) { this.wave++; this.floatText(this.cx, this.cy-100, `WAVE ${this.wave}`, '#ff003c'); }

                // 2. 战斗逻辑 (主炮)
                const gLvl = this.upgrades.gun.lvl;
                if(this.frame - this.lastFire > Math.max(10, 80 - gLvl*10)) {
                    const target = this.getNearest();
                    if(target) {
                        this.lastFire = this.frame;
                        AudioSys.sfx('shoot');
                        const ang = Math.atan2(target.y - this.cy, target.x - this.cx);
                        // 多重射击逻辑
                        let count = gLvl >= 5 ? 3 : (gLvl >= 3 ? 2 : 1);
                        for(let i=0; i<count; i++) {
                            const spread = (i - (count-1)/2) * 0.15;
                            this.bullets.push({
                                x: this.cx, y: this.cy,
                                vx: Math.cos(ang+spread)*8, vy: Math.sin(ang+spread)*8,
                                dmg: 5+gLvl*3, life: 100, color: '#00f3ff'
                            });
                        }
                    }
                }

                // 浮游炮
                const tLvl = this.upgrades.turret.lvl;
                if(tLvl > 0 && this.frame % 40 === 0) {
                    for(let i=0; i<tLvl; i++) {
                        const tAng = (this.frame*0.01) + (i * (Math.PI*2/tLvl));
                        const tx = this.cx + Math.cos(tAng)*80, ty = this.cy + Math.sin(tAng)*80;
                        const target = this.getNearest(tx, ty);
                        if(target) {
                            const ang = Math.atan2(target.y - ty, target.x - tx);
                            this.bullets.push({ x: tx, y: ty, vx: Math.cos(ang)*6, vy: Math.sin(ang)*6, dmg: 5, life: 60, color: '#ffd700' });
                        }
                    }
                }

                // 3. 物理更新
                // 减速力场
                const sLvl = this.upgrades.stasis.lvl;
                const sRange = sLvl * 60 + 100;

                this.enemies.forEach(e => {
                    const ang = Math.atan2(this.cy - e.y, this.cx - e.x);
                    let spd = e.speed;
                    if(sLvl > 0 && Math.hypot(this.cx-e.x, this.cy-e.y) < sRange) spd *= 0.4;
                    
                    e.x += Math.cos(ang)*spd; e.y += Math.sin(ang)*spd;
                    // 拖尾粒子
                    if(Math.random()>0.5) this.particles.push(new Particle(e.x, e.y, 'enemy_trail'));

                    // 撞击
                    if(Math.hypot(this.cx-e.x, this.cy-e.y) < 40) {
                        e.dead = true; this.hp -= 10; this.updateUI();
                        AudioSys.sfx('hit');
                        this.spawnParticle(e.x, e.y, 'spark', 20);
                        if(this.hp<=0) { alert('SYSTEM FAILURE'); location.reload(); }
                    }
                });

                this.bullets.forEach(b => {
                    b.x += b.vx; b.y += b.vy; b.life--;
                    this.spawnParticle(b.x, b.y, 'trail');
                    for(let e of this.enemies) {
                        if(Math.hypot(b.x-e.x, b.y-e.y) < e.radius + 5) {
                            b.life = 0; e.hp -= b.dmg;
                            this.spawnParticle(b.x, b.y, 'spark', 3);
                            if(e.hp<=0) {
                                e.dead = true;
                                this.spawnParticle(e.x, e.y, 'spark', 15);
                            }
                            break;
                        }
                    }
                });

                // 资源球
                this.orbs.forEach(o => {
                    o.x += o.vx; o.y += o.vy; o.life--; o.angle += 0.05;
                });

                // 粒子更新
                this.particles.forEach(p => p.update());
                
                // 清理
                this.enemies = this.enemies.filter(e => !e.dead);
                this.bullets = this.bullets.filter(b => b.life > 0);
                this.orbs = this.orbs.filter(o => o.life > 0);
                this.particles = this.particles.filter(p => p.life > 0);

                this.draw();
                requestAnimationFrame(() => this.loop());
            },

            // --- 渲染 (Additive Blending) ---
            draw() {
                // 拖尾效果
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                this.ctx.fillRect(0, 0, this.w, this.h);
                
                // 开启发光模式 (核心技术)
                this.ctx.globalCompositeOperation = 'lighter';

                // 1. 核心 Qi (粒子态)
                for(let i=0; i<5; i++) {
                    const ang = Math.random() * Math.PI*2;
                    const r = 30 + Math.random()*10;
                    this.particles.push(new Particle(this.cx+Math.cos(ang)*r, this.cy+Math.sin(ang)*r, 'core'));
                }
                
                // 减速力场
                if(this.upgrades.stasis.lvl > 0) {
                    const r = this.upgrades.stasis.lvl * 60 + 100;
                    this.ctx.strokeStyle = 'rgba(0, 243, 255, 0.1)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath(); this.ctx.arc(this.cx, this.cy, r, 0, Math.PI*2); this.ctx.stroke();
                }

                // 2. 绘制所有粒子
                this.particles.forEach(p => p.draw(this.ctx));

                // 3. 绘制实体 (用发光几何体代替图片)
                
                // 资源
                this.orbs.forEach(o => {
                    this.ctx.fillStyle = '#00f3ff';
                    this.ctx.beginPath(); this.ctx.arc(o.x, o.y, o.r, 0, Math.PI*2); this.ctx.fill();
                    // 环绕光环
                    this.ctx.strokeStyle = '#00f3ff';
                    this.ctx.beginPath(); 
                    this.ctx.arc(o.x, o.y, o.r+5, o.angle, o.angle+Math.PI); 
                    this.ctx.stroke();
                });

                // 敌人
                this.enemies.forEach(e => {
                    this.ctx.fillStyle = e.color;
                    this.ctx.beginPath();
                    this.ctx.moveTo(e.x + Math.cos(this.frame*0.1)*e.radius, e.y + Math.sin(this.frame*0.1)*e.radius);
                    for(let i=1; i<3; i++) {
                        const a = (this.frame*0.1) + i*(Math.PI*2/3);
                        this.ctx.lineTo(e.x+Math.cos(a)*e.radius, e.y+Math.sin(a)*e.radius);
                    }
                    this.ctx.fill();
                });

                // 子弹
                this.bullets.forEach(b => {
                    this.ctx.fillStyle = b.color;
                    this.ctx.beginPath(); this.ctx.arc(b.x, b.y, 3, 0, Math.PI*2); this.ctx.fill();
                });

                // 浮游炮
                const tLvl = this.upgrades.turret.lvl;
                if(tLvl > 0) {
                    this.ctx.fillStyle = '#ffb000';
                    for(let i=0; i<tLvl; i++) {
                        const ang = (this.frame*0.01) + (i * (Math.PI*2/tLvl));
                        this.ctx.fillRect(this.cx+Math.cos(ang)*80-4, this.cy+Math.sin(ang)*80-4, 8, 8);
                    }
                }

                // 恢复正常混合
                this.ctx.globalCompositeOperation = 'source-over';
            },

            getNearest(x=this.cx, y=this.cy) {
                let n=null, min=Infinity;
                for(let e of this.enemies) {
                    const d = Math.hypot(e.x-x, e.y-y);
                    if(d<min) { min=d; n=e; }
                }
                return n;
            },

            floatText(x, y, txt, col) {
                const el = document.createElement('div');
                el.className = 'floater';
                el.style.left = x+'px'; el.style.top = y+'px'; el.style.color = col;
                el.innerText = txt;
                document.getElementById('ui-layer').appendChild(el);
                setTimeout(()=>el.remove(), 1000);
            },

            updateUI() {
                document.getElementById('ui-energy').innerText = Math.floor(this.energy);
                document.getElementById('ui-wave').innerText = this.wave;
                document.getElementById('ui-hp-bar').style.width = (this.hp/this.maxHp)*100 + '%';
                document.getElementById('ui-hp-text').innerText = Math.ceil(this.hp);
                
                this.updateBtn('gun'); this.updateBtn('turret'); this.updateBtn('stasis');
                this.updateBtn('rate'); this.updateBtn('heal');
            },

            updateBtn(id) {
                const u = this.upgrades[id];
                const btn = document.getElementById('btn-'+id);
                document.getElementById('cost-'+id).innerText = u.cost;
                if(u.max && document.getElementById('lv-'+id)) document.getElementById('lv-'+id).innerText = u.lvl;
                
                if(id==='gun') document.getElementById('desc-gun').innerText = u.lvl>=5?"散射风暴":(u.lvl>=3?"双发":"单发");

                if(this.energy < u.cost || (u.max && u.lvl>=u.max)) btn.classList.add('disabled');
                else btn.classList.remove('disabled');
            }
        };
    </script>
</body>
</html>
